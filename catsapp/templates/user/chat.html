<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CatsApp - Chat</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/user.css') }}">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&icon_names=add" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&icon_names=settings" />
</head>
<body>

    {% if session.get('user_id') %}
    <nav class="navbar">
        <div class="navbar1">
            <a href="#" class="logo">
                <img src="https://ui-avatars.com/api/?name=test&background=random" >
            </a>
        </div>

        <div class="navbar2">
            <form id="add-contact-form" class="contact-form">
                <input type="text" id="contact-username" class="input-field" placeholder="Ajoutez un contact" required>
                <button type="submit" class="btn-send">
                    <span class="material-symbols-outlined rotate-90-cw">add</span>
                </button>
            </form>
        </div>

        <div class="navbar3">
            <div class="btn-settings">
                <button type="" class="btn-settings">
                    <span class="material-symbols-outlined rotate-center">settings</span>
                </button>
                <a class="nav-link" href="{{ url_for('logout') }}"></a>
            </div>
        </div>

    </nav>
    {% endif %}

    
    <!-- Flash messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flash-messages">
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}
    
    <div class="main-container">
        <p id="add-contact-message" class="success-message"></p>
        <h3>Demandes de contact</h3>
        <ul id="pending-contacts"></ul>
        
        <div class="sidebar">
            <h5>Contacts</h5>
            <div class="list-group">
                {% for contact in contacts %}
                    <a href="{{ url_for('chat', contact_id=contact.id) }}" class="list-item {% if contact.id == current_contact.id %}active{% endif %}">
                        <div class="contact-item">
                            <img src="https://ui-avatars.com/api/?name={{ contact.username }}&background=random" class="contact-avatar" width="40" height="40">
                            <div class="contact-info">
                                <h6>{{ contact.username }}</h6>
                                {% if contact.last_message %}
                                    <small>{{ contact.last_message[:30] }}..</small>
                                {% endif %}
                            </div>
                        </div>
                    </a>
                {% endfor %}
            </div>
    
        </div>
    
        <!-- Zone de chat -->
        <div class="chat-container">
            {% if current_contact %}
                <div class="chat-header">
                    <img src="https://ui-avatars.com/api/?name={{ current_contact.username }}&background=random" class="contact-avatar" width="40" height="40">
                    <h5>{{ current_contact.username }}</h5>
                </div>
                <div class="chat-box" id="messageContainer">
                    {% for message in messages %}
                        {% if message.sender_id == session.user_id %}
                            <div class="message text-end">
                                <div class="message-sender">{{ message.content }}</div>
                                <small class="message-time">{{ message.created_at.strftime('%H:%M') }}</small>
                            </div>
                        {% else %}
                            <div class="message text-start">
                                <div class="message-receiver">{{ message.content }}</div>
                                <small class="message-time">{{ message.created_at.strftime('%H:%M') }}</small>
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
    
                <!-- Zone de saisie -->
                <form id="messageForm" class="input-container">
                    <input type="text" id="messageContent" class="input-field" placeholder="Votre message...">
                    <button type="submit" class="btn-send"><i class="fa fa-paper-plane"></i></button>
                </form>
            {% else %}
                <div class="no-contact-message">
                    <p class="text-muted">Sélectionnez un contact pour commencer à chatter</p>
                </div>
            {% endif %}
        </div>
    </div>
    



<script>
    document.getElementById("add-contact-form").addEventListener("submit", function(event) {
        event.preventDefault();
        let username = document.getElementById("contact-username").value;

        fetch('/contacts/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username: username })
        })
        .then(response => response.json())
        .then(data => {
            let messageElem = document.getElementById("add-contact-message");
            messageElem.style.color = data.success ? "green" : "red";
            messageElem.textContent = data.message;
        })
        .catch(error => console.error('Erreur:', error));
    });

    function loadPendingContacts() {
        fetch('/contacts/pending')
        .then(response => response.json())
        .then(data => {
            let list = document.getElementById("pending-contacts");
            list.innerHTML = data.contacts.length === 0 ? "<p>Aucune demande en attente</p>" : "";
            data.contacts.forEach(contact => {
                let li = document.createElement("li");
                li.innerHTML = `${contact.username}
                    <button onclick="acceptContact(${contact.id})">Accepter</button>
                    <button onclick="blockContact(${contact.id})">Bloquer</button>`;
                list.appendChild(li);
            });
        })
        .catch(error => console.error("Erreur lors du chargement des demandes:", error));
    }

    function acceptContact(contactId) {
        fetch('/contacts/accept', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contact_id: contactId })
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            loadPendingContacts();
        })
        .catch(error => console.error("Erreur:", error));
    }

    function blockContact(contactId) {
        fetch('/contacts/block', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contact_id: contactId })
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            loadPendingContacts();
        })
        .catch(error => console.error("Erreur:", error));
    }

    document.addEventListener("DOMContentLoaded", loadPendingContacts);

    {% if current_contact %}
    const messageForm = document.getElementById("messageForm");
    const messageContent = document.getElementById("messageContent");
    const messageContainer = document.getElementById("messageContainer");

    function reloadMessages() {
        fetch('{{ url_for("chat", contact_id=current_contact.id) }}')
        .then(response => response.text())
        .then(html => {
            let parser = new DOMParser();
            let doc = parser.parseFromString(html, 'text/html');
            messageContainer.innerHTML = doc.getElementById('messageContainer').innerHTML;
            messageContainer.scrollTop = messageContainer.scrollHeight;
        })
        .catch(error => console.error('Erreur:', error));
    }

    messageForm.addEventListener("submit", function(e) {
        e.preventDefault();
        let content = messageContent.value.trim();
        if (content) {
            fetch('{{ url_for("send_message") }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contact_id: {{ current_contact.id }}, message: content })
            }).then(response => response.json())
            .then(() => {
                messageContent.value = '';
                reloadMessages();
            }).catch(error => console.error('Erreur:', error));
        }
    });
    {% endif %}
</script>

</body>
</html>
