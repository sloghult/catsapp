{% extends "base.html" %}

{% block title %}CatsApp - Chat{% endblock %}

{% block content %}
<div>
    <div>
        <!-- Liste des contacts -->
        <div class="">
            <div class="">
                <div class="">
                    <h5 class="">Contacts</h5>
                </div>
                <div class="">
                    {% for contact in contacts %}
                    <a href="{{ url_for('chat', contact_id=contact.id) }}" 
                       class=" {% if contact.id == current_contact.id %}active{% endif %}">
                        <div style="display: flex; align-items: center;">
                            <img src="https://ui-avatars.com/api/?name={{ contact.username }}&background=random" 
                                 class="rounded-circle me-2" width="40" height="40">
                            <div>
                                <h6 class="">{{ contact.username }}</h6>
                                {% if contact.last_message %}
                                <small class="">{{ contact.last_message[:30] }}..</small>
                                {% endif %}
                            </div>
                        </div>
                    </a>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Zone de chat -->
        <div class="">
            {% if current_contact %}
            <div class="">
                <!-- En-tête du chat -->
                <div class="">
                    <div class="">
                        <img src="https://ui-avatars.com/api/?name={{ current_contact.username }}&background=random" 
                             class="rounded-circle me-2" width="40" height="40">
                        <h5 class="">{{ current_contact.username }}</h5>
                    </div>
                </div>

                <!-- Messages -->
                <div class="" id="messageContainer">
                    {% for message in messages %}
                        {% if message.sender_id == session.user_id %}
                            <div class="">
                                <div class="">
                                    {{ message.content }}
                                </div>
                                <small class="">{{ message.created_at.strftime('%H:%M') }}</small>
                            </div>
                        {% else %}
                            <div class="">
                                <div class="">
                                    {{ message.content }}
                                </div>
                                <small class="">{{ message.created_at.strftime('%H:%M') }}</small>
                            </div>
                        {% endif %}
                    {% endfor %}
                    <div id="" style="display: none;">
                        <div class="">
                            <div class="">
                                <em>En train d'écrire...</em>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Zone de saisie -->
                <div class="">
                    <form id="messageForm">
                        <div class="">
                            <input type="text" id="messageContent" class="form-control" placeholder="Votre message...">
                            <button type="submit" class="">
                                <i class=""></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            {% else %}
            <div class="">
                <div class="">
                    <i class=""></i>
                    <p class="">Sélectionnez un contact pour commencer à chatter</p>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        {% if current_contact %}
            const messageContainer = document.getElementById('messageContainer');
            const messageForm = $('#messageForm');
            const messageContent = $('#messageContent');
            let typingTimeout;

            // Faire défiler jusqu'aux derniers messages
            messageContainer.scrollTop = messageContainer.scrollHeight;

            // Fonction pour recharger les messages
            function reloadMessages() {
                fetch('{{ url_for("chat", contact_id=current_contact.id) }}')
                    .then(response => response.text())
                    .then(html => {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');
                        const newMessages = doc.getElementById('messageContainer').innerHTML;
                        messageContainer.innerHTML = newMessages;
                        messageContainer.scrollTop = messageContainer.scrollHeight;
                    });
            }

            // Envoyer un message
            messageForm.on('submit', function(e) {
                e.preventDefault();
                const content = messageContent.val().trim();
                if (content) {
                    fetch('{{ url_for("send_message") }}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            receiver_id: {{ current_contact.id }},
                            content: content
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            messageContent.val('');
                            reloadMessages(); // Recharger pour voir le message déchiffré
                        }
                    });
                }
            });

            // Événement de frappe
            messageContent.on('input', function() {
                clearTimeout(typingTimeout);
                fetch('{{ url_for("typing") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        receiver_id: {{ current_contact.id }}
                    })
                });
                
                typingTimeout = setTimeout(() => {
                    // Le timeout est géré côté serveur
                }, 2000);
            });

            // Écouter les événements de socket
            socket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                
                if (data.type === 'typing' && data.user_id == {{ current_contact.id }}) {
                    showTypingIndicator();
                }
            };

            function showTypingIndicator() {
                const indicator = document.getElementById('typingIndicator');
                indicator.style.display = 'block';
                messageContainer.scrollTop = messageContainer.scrollHeight;
                
                
                // Cacher l'indicateur après 2 secondes
                setTimeout(() => {
                    indicator.style.display = 'none';
                }, 2000);
            }
        {% endif %}
    });
</script>
{% endblock %}
